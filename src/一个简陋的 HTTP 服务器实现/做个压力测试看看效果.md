# 做个压力测试看看效果

在实际的应用场景当中，服务器需要处理来自多个客户端的大量进程/线程，那么我们要怎样测试服务器的处理能力呢？我们总不可能叫上一伙人一个一个地开网页吧，总得有个工具做压力测试。这里就用一个 npm 里的小工具 loadtest 做压力测试。因为一般服务器都在 Linux 系统上运行，我们就在一台 Linux 服务器上测试性能。

打开服务器，让它开始监听端口。然后再输入：

```bash
loadtest -t 10 -c 100 http://127.0.0.1:8080/
```

让我们看看会发生什么。

100、500、1000，看样子都没有问题！然而当并发请求达到 2000 ，这个简陋的服务器就开始有错误请求了。由于我们一开始就没用``unwrap``直接让内核恐慌，而是写了错误处理相关的语句，所以相关的错误也会打印到终端当中。就让我们看看服务器在处理这些请求的过程中出了什么问题吧：

![服务器在 2000 及以上并发请求时出现的问题]()

```
Error(Os 2): Too many Open Files
```

在搜索引擎上直接搜索关键词，搜到的很多资料会告诉你可以去``/etc/security/limit.conf``上增加同时打开的文件上限或者直接设置``ulimit -SHn 10000 ``，~~于是你就可以把 ulimit 调到 10000，然后 C10K 问题就彻底解决了。~~

开玩笑的xD 真这么做的话，没过几秒服务器就会因为 I/O 资源不够而崩溃（除非你的服务器性能很好）。不过上个5K还是可以的，虽然请求错误还是避不掉。

就只能到此为止了吗？我们只能响应一次请求就开一个线程，而且这个线程还时常需要干等吗？

并不是。Rust 有很多第三方网络库提供了良好的异步 I/O 支持，不仅是异步 I/O，这些库对协程也有或多或少的支持。



### 补充

- 如果你是在 Windows 上做的压力测试，那么很遗憾，你在 Windows 上做的那一套并不适用于 Unix 系统（包括但不限于 Linux、macOS 和 BSD）。Windows 的进程/线程管理和 Unix 系统有很大的区别。

